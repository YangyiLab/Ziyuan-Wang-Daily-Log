- [2022-3-1](#2022-3-1)
  - [PLAN](#plan)
  - [机器学习基础](#%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80)
    - [数据结构](#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84)
    - [预处理](#%E9%A2%84%E5%A4%84%E7%90%86)
    - [优化算法](#%E4%BC%98%E5%8C%96%E7%AE%97%E6%B3%95)
- [2022-3-5](#2022-3-5)
  - [PLAN](#plan-1)
  - [拟南芥项目逻辑](#%E6%8B%9F%E5%8D%97%E8%8A%A5%E9%A1%B9%E7%9B%AE%E9%80%BB%E8%BE%91)
  - [大修文章](#%E5%A4%A7%E4%BF%AE%E6%96%87%E7%AB%A0)
- [2022-3-6](#2022-3-6)
  - [PLAN](#plan-2)
  - [NODE](#node)
  - [PSMC MSMC](#psmc-msmc)
- [2022-3-7](#2022-3-7)
  - [PLAN](#plan-3)
  - [单细胞数据迁移](#%E5%8D%95%E7%BB%86%E8%83%9E%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB)
  - [Ryan Gutenkunst Research](#ryan-gutenkunst-research)
    - [分子间相互作用](#%E5%88%86%E5%AD%90%E9%97%B4%E7%9B%B8%E4%BA%92%E4%BD%9C%E7%94%A8)
    - [联合AFS推断新突变的适应度效应分布（DFE）](#%E8%81%94%E5%90%88afs%E6%8E%A8%E6%96%AD%E6%96%B0%E7%AA%81%E5%8F%98%E7%9A%84%E9%80%82%E5%BA%94%E5%BA%A6%E6%95%88%E5%BA%94%E5%88%86%E5%B8%83dfe)
- [2022-3-8](#2022-3-8)
  - [PLAN](#plan-4)
  - [单细胞数据迁移训练](#%E5%8D%95%E7%BB%86%E8%83%9E%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB%E8%AE%AD%E7%BB%83)
    - [GPU问题](#gpu%E9%97%AE%E9%A2%98)
    - [预训练问题](#%E9%A2%84%E8%AE%AD%E7%BB%83%E9%97%AE%E9%A2%98)
- [2022-3-9](#2022-3-9)
  - [PLAN](#plan-5)
  - [单细胞tf 预训练](#%E5%8D%95%E7%BB%86%E8%83%9Etf-%E9%A2%84%E8%AE%AD%E7%BB%83)
    - [无kld](#%E6%97%A0kld)
    - [有kld](#%E6%9C%89kld)
  - [拟南芥基因组缩小原因](#%E6%8B%9F%E5%8D%97%E8%8A%A5%E5%9F%BA%E5%9B%A0%E7%BB%84%E7%BC%A9%E5%B0%8F%E5%8E%9F%E5%9B%A0)
  - [meta - learning](#meta---learning)
- [2022-3-10](#2022-3-10)
  - [PLAN](#plan-6)
  - [毕业设计文献综述](#%E6%AF%95%E4%B8%9A%E8%AE%BE%E8%AE%A1%E6%96%87%E7%8C%AE%E7%BB%BC%E8%BF%B0)
  - [meta-learning](#meta-learning)
    - [分类](#%E5%88%86%E7%B1%BB)
    - [数据准备](#%E6%95%B0%E6%8D%AE%E5%87%86%E5%A4%87)
- [2022-3-11](#2022-3-11)
  - [PLAN](#plan-7)
  - [meta-learning学习整理](#meta-learning%E5%AD%A6%E4%B9%A0%E6%95%B4%E7%90%86)
    - [Overview](#overview)
    - [Matching](#matching)
    - [MAML](#maml)
  - [单细胞](#%E5%8D%95%E7%BB%86%E8%83%9E)
    - [均值恢复不好的原因](#%E5%9D%87%E5%80%BC%E6%81%A2%E5%A4%8D%E4%B8%8D%E5%A5%BD%E7%9A%84%E5%8E%9F%E5%9B%A0)
- [2022-3-12](#2022-3-12)
  - [PLAN](#plan-8)
  - [单细胞预训练](#%E5%8D%95%E7%BB%86%E8%83%9E%E9%A2%84%E8%AE%AD%E7%BB%83)
    - [GENE2TF](#gene2tf)
    - [TF2GENE](#tf2gene)
- [2022-3-13](#2022-3-13)
  - [PLAN](#plan-9)
  - [权值预训练](#%E6%9D%83%E5%80%BC%E9%A2%84%E8%AE%AD%E7%BB%83)
- [2022-3-14](#2022-3-14)
  - [PLAN](#plan-10)
  - [拟南芥数据处理](#%E6%8B%9F%E5%8D%97%E8%8A%A5%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86)
    - [下载代码更新](#%E4%B8%8B%E8%BD%BD%E4%BB%A3%E7%A0%81%E6%9B%B4%E6%96%B0)
  - [mask 代码](#mask-%E4%BB%A3%E7%A0%81)
  - [单细胞药学开发](#%E5%8D%95%E7%BB%86%E8%83%9E%E8%8D%AF%E5%AD%A6%E5%BC%80%E5%8F%91)
    - [应用](#%E5%BA%94%E7%94%A8)
    - [耐药性研究](#%E8%80%90%E8%8D%AF%E6%80%A7%E7%A0%94%E7%A9%B6)
    - [迁移学习](#%E8%BF%81%E7%A7%BB%E5%AD%A6%E4%B9%A0)
- [2022-3-15](#2022-3-15)
  - [PLAN](#plan-11)
  - [成果收集](#%E6%88%90%E6%9E%9C%E6%94%B6%E9%9B%86)
- [2022-3-16](#2022-3-16)
  - [PLAN](#plan-12)
  - [下载代码步骤](#%E4%B8%8B%E8%BD%BD%E4%BB%A3%E7%A0%81%E6%AD%A5%E9%AA%A4)
- [2022-3-17](#2022-3-17)
  - [PLAN](#plan-13)
  - [单细胞代码](#%E5%8D%95%E7%BB%86%E8%83%9E%E4%BB%A3%E7%A0%81)
    - [Encoder Pretrain](#encoder-pretrain)
    - [latent space注意顺序](#latent-space%E6%B3%A8%E6%84%8F%E9%A1%BA%E5%BA%8F)
- [2022-3-18](#2022-3-18)
  - [PLAN](#plan-14)
  - [TE重构代码](#te%E9%87%8D%E6%9E%84%E4%BB%A3%E7%A0%81)
- [2022-3-19](#2022-3-19)
  - [PLAN](#plan-15)
  - [单细胞工作设计](#%E5%8D%95%E7%BB%86%E8%83%9E%E5%B7%A5%E4%BD%9C%E8%AE%BE%E8%AE%A1)
- [2022-3-21](#2022-3-21)
  - [PLAN](#plan-16)
  - [权值](#%E6%9D%83%E5%80%BC)
    - [TF predicted-TF 存在线性关系](#tf-predicted-tf-%E5%AD%98%E5%9C%A8%E7%BA%BF%E6%80%A7%E5%85%B3%E7%B3%BB)
  - [文献](#%E6%96%87%E7%8C%AE)
    - [主题](#%E4%B8%BB%E9%A2%98)
    - [单细胞测序](#%E5%8D%95%E7%BB%86%E8%83%9E%E6%B5%8B%E5%BA%8F)
    - [转录因子](#%E8%BD%AC%E5%BD%95%E5%9B%A0%E5%AD%90)
- [2022-3-22](#2022-3-22)
  - [PLAN](#plan-17)
  - [hsc转录调控](#hsc%E8%BD%AC%E5%BD%95%E8%B0%83%E6%8E%A7)
  - [训练流程](#%E8%AE%AD%E7%BB%83%E6%B5%81%E7%A8%8B)
    - [Code](#code)
    - [Flow](#flow)
- [2022-3-23](#2022-3-23)
  - [PLAN](#plan-18)
  - [单细胞benchmark 数据overview](#%E5%8D%95%E7%BB%86%E8%83%9Ebenchmark-%E6%95%B0%E6%8D%AEoverview)
  - [单细胞预训练文献](#%E5%8D%95%E7%BB%86%E8%83%9E%E9%A2%84%E8%AE%AD%E7%BB%83%E6%96%87%E7%8C%AE)
- [2022-3-24](#2022-3-24)
  - [PLAN](#plan-19)
  - [R脚本](#r%E8%84%9A%E6%9C%AC)
  - [文献阅读](#%E6%96%87%E7%8C%AE%E9%98%85%E8%AF%BB)
- [2022-3-25](#2022-3-25)
  - [PLAN](#plan-20)
  - [R语言图论学习(igraph)](#r%E8%AF%AD%E8%A8%80%E5%9B%BE%E8%AE%BA%E5%AD%A6%E4%B9%A0igraph)
  - [PageRank 学习](#pagerank-%E5%AD%A6%E4%B9%A0)
- [2022-3-26](#2022-3-26)
  - [PLAN](#plan-21)
  - [拟南芥结论](#%E6%8B%9F%E5%8D%97%E8%8A%A5%E7%BB%93%E8%AE%BA)
  - [拟南芥可视化](#%E6%8B%9F%E5%8D%97%E8%8A%A5%E5%8F%AF%E8%A7%86%E5%8C%96)
- [2022-3-26](#2022-3-26-1)
  - [PLAN](#plan-22)
  - [气候数据处理](#%E6%B0%94%E5%80%99%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86)
    - [R语言处理方法](#r%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E6%96%B9%E6%B3%95)
    - [Bio 1-19](#bio-1-19)
- [2022-3-28](#2022-3-28)
  - [PLAN](#plan-23)
  - [数据处理分组](#%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86%E5%88%86%E7%BB%84)
    - [分组1](#%E5%88%86%E7%BB%841)
    - [分组2](#%E5%88%86%E7%BB%842)
    - [分组3](#%E5%88%86%E7%BB%843)
    - [分组4](#%E5%88%86%E7%BB%844)
  - [图神经网络](#%E5%9B%BE%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C)
    - [node2vec](#node2vec)
    - [GCN](#gcn)
- [2022-3-29](#2022-3-29)
  - [PLAN](#plan-24)
  - [index 问题解决](#index-%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3)
  - [拟南芥可视化](#%E6%8B%9F%E5%8D%97%E8%8A%A5%E5%8F%AF%E8%A7%86%E5%8C%96-1)
    - [boxplot](#boxplot)
    - [corrplots](#corrplots)
- [2022-3-30](#2022-3-30)
  - [PLAN](#plan-25)
  - [GRN](#grn)
  - [单细胞训练](#%E5%8D%95%E7%BB%86%E8%83%9E%E8%AE%AD%E7%BB%83)
  - [文献阅读](#%E6%96%87%E7%8C%AE%E9%98%85%E8%AF%BB-1)
- [2022-3-31](#2022-3-31)
  - [PLAN](#plan-26)
  - [拟南芥数据](#%E6%8B%9F%E5%8D%97%E8%8A%A5%E6%95%B0%E6%8D%AE)
    - [有问题数据](#%E6%9C%89%E9%97%AE%E9%A2%98%E6%95%B0%E6%8D%AE)
    - [TE 转座子benchmark](#te-%E8%BD%AC%E5%BA%A7%E5%AD%90benchmark)
    - [问题](#%E9%97%AE%E9%A2%98)
  - [GRN](#grn-1)


# 2022-3-1

## PLAN
+ **深度学习基础理论学习**
+ 陆老师文献综述

## 机器学习基础

### 数据结构

N-维数据

+ 0维数组 浮点数
+ 1-d [1.0,2.7,3.4] 一个样本
+ 2-d 特征矩阵 多个样本
+ 3-d RGB图片 宽、高、通道
+ 4-d 一个batch的图片

[1:3,:] 1 2 行 [1,3)

dim = 0 按行合并 向下堆 [3,4] [3,4] [6,4]
dim = 1 按列合并 向又加

### 预处理

用 readcsv 读

处理缺失 插值法

```py
inputs = inputs.fillna(inputs.mean())
```

### 优化算法

+ 小批量梯度下降 随机梯度下降 比 梯度下降慢 加大批量时随机梯度下降比较快
+ 冲量法 使用平滑过的梯度进行更新 
+ Adam 做了很多的平滑 对学习率不敏感


# 2022-3-5

## PLAN

+ **拟南芥甲基化文献讲解**
+ **毕业设计文献翻译1**
+ **大修文章创建修改稿**


## 拟南芥项目逻辑

+ 拟南芥的基因组大小不同
+ 原因是转座子有关
+ 转座子活性和甲基化有关
+ G4和甲基化
+ 环境影响G4折叠 影响甲基化

全基因组大小 TE序列的数量 TE序列的bp 活性TE家族数 TE序列/基因组序列 G4数量 G4被甲基化的数量 $\frac{G4中甲基化的bp/G4的bp}{全基因组甲基化的bp/全基因组大小}$

## 大修文章

差一个major review问题和 R2的minor review问题


# 2022-3-6

## PLAN

+ **大修文章完成R2minor修改**
+ **文献阅读**
+ **深度学习微分方程**


## NODE

深度学习解微分方程原理利用神经网络模拟差分过程

## PSMC MSMC

利用隐马尔可夫模型估计有效群体大小

为第三类问题即参数估计问题

在转移概率计算中变异重组有效群体都可以计算

# 2022-3-7

## PLAN

+ **单细胞数据迁移**
+ **大修GitHub文件整理**
+ **Ryan Gutenkunst Research**

## 单细胞数据迁移

**目前问题**

+ GPU显存不够
+ 计算的GPU和CPU区分

## Ryan Gutenkunst Research

### 分子间相互作用

动力学/调控网络

### 联合AFS推断新突变的适应度效应分布（DFE）

# 2022-3-8

## PLAN

+ **大修文章cover letter 定稿**
+ **单细胞数据迁移训练**

## 单细胞数据迁移训练

### GPU问题

使用 SGD进行优化更加节省内存

### 预训练问题

+ 多个组预训练效果不好，尝试下单个组预训练
+ 修改下beta权重

# 2022-3-9

## PLAN

+ **单细胞 加入kld 预训练**
+ **文献阅读**
+ **meta - learning**

## 单细胞tf 预训练

### 无kld
不同类型细胞tf恢复相关性不同

### 有kld

开始版本可能训练不充分

## 拟南芥基因组缩小原因

拟南芥基因组的缩小取决于基因组的失活或者TE Elimination

## meta - learning

overview 学习相似任务的共性

# 2022-3-10

## PLAN

+ **毕业设计文献综述**
+ **csbj投稿**
+ **微生物投稿**
+ **meta-learning**

## 毕业设计文献综述

包括了病毒基因组的部分以及NLP进展部分

## meta-learning

### 分类

+ 按照参数学习能力 同输入不同输出的学习 同输出不同情况输入的任务学习等  
+ 按照学习约束 找到不同任务的共同约束

### 数据准备

外层 训练 测试 验证
内层 训练 测试

外层中每一个数据集都包含内层的两种数据集即6种

如元训练集 每个任务 包含N分类每个分类下有K个样本的数据集作为训练集，包含N分类每个分类下有K个样本的数据集作为训练集，剩余样本作为测试集

其他两个外层相同

# 2022-3-11

## PLAN

+ **meta learning 学习**
+ **单细胞工作整理**
+ **微生物投稿**

## meta-learning学习整理

### Overview

+ pre-train
+ FSL few-shot learn

### Matching

特征向量cos 相似度


### MAML

多任务找到比较好的$\hat{\theta}$,以便让测试任务中每一个任务都能迭代到好结果。

## 单细胞

### 均值恢复不好的原因

可能分类就不够明确，导致均值不一定能复现

# 2022-3-12

## PLAN

+ **毕设文件整理**
+ **单细胞预训练**


## 单细胞预训练

### GENE2TF

相关性大约在0.4-0.6 beta=0.05

### TF2GENE

相关性0.8以上

# 2022-3-13

## PLAN

+ **毕业设计中期整理**
+ **预训练权值研究**

## 权值预训练

```py
from functools import reduce
from pickle import load
import torch
import numpy as np
import torch.nn.functional as F
from torch import  nn, optim
import scanpy as sc
from scipy import sparse
import pandas as pd
import Custom_dataLoader
import VAE_model
from torch.utils.data import DataLoader
from early_stop import EarlyStopping
model = torch.load("/home/ubuntu/MLPackageStudy/VAE/in-silico/model_Version_2/decoder_human_checkpoint.pt",map_location="cpu")
model
z2tf = 0
for name,parameters in model.named_parameters():
    if name.startswith("z2tf2.fc_layers.Layer 0.0.weight"):
        print(name,':',parameters)
        z2tf = parameters
torch.argmax(torch.abs(z2tf))
_, idx1 = torch.sort(torch.abs(z2tf).reshape(-1), descending=False)#descending为alse，升序，为True，降序
idx = idx1[:int(z2tf.shape[0]*z2tf.shape[1]*0.5)]
z2tf.view(-1)[idx]
```

进一步参考vega代码进行mask进一步操作

```py
def create_pathway_mask(feature_list, dict_pathway, add_missing=1, fully_connected=True, to_tensor=False):
    """
    Creates a mask of shape [genes,pathways] where (i,j) = 1 if gene i is in pathway j, 0 else.

    Expects a list of genes and pathway dict.
    Note: dict_pathway should be an Ordered dict so that the ordering can be later interpreted.

    Args:
        feature_list (list): List of genes in single-cell dataset.
        dict_pathway (OrderedDict): Dictionary of gene_module:genes.
        add_missing (int): Number of additional, fully connected nodes.
        fully_connected (bool): Whether to fully connect additional nodes or not.
        to_tensor (False): Whether to convert mask to tensor or not.
    Returns:
        torch.tensor/np.array: Gene module mask.
    """
    assert type(dict_pathway) == OrderedDict
    p_mask = np.zeros((len(feature_list), len(dict_pathway)))
    for j, k in enumerate(dict_pathway.keys()):
        for i in range(p_mask.shape[0]):
            if feature_list[i] in dict_pathway[k]:
                p_mask[i,j] = 1.
    if add_missing:
        n = 1 if type(add_missing)==bool else add_missing
        # Get non connected genes
        if not fully_connected:
            idx_0 = np.where(np.sum(p_mask, axis=1)==0)
            vec = np.zeros((p_mask.shape[0],n))
            vec[idx_0,:] = 1.
        else:
            vec = np.ones((p_mask.shape[0], n))
        p_mask = np.hstack((p_mask, vec))
    if to_tensor:
        p_mask = torch.Tensor(p_mask)
    return p_mask
```

创建mask矩阵 tf_mask [ i, j ] = 1 如果他们的关系够大 否则为0


# 2022-3-14

## PLAN

+ **完成mask 函数**
+ **拟南芥数据预处理**
+ **文献阅读**

## 拟南芥数据处理

```r

###### 数据预处理 #####··1  1                                                                                                                                                           
data <-read.table(file="/home/ubuntu/Arabidopsis/Scripts/datasetA.csv", header=TRUE, sep=",")
data$G4_MC_rate_bp
data <- data[,c(-1)]
colnames(data)[1] <- 'Num'


accessions_altitude <-read.table(file="/home/ubuntu/Arabidopsis/accessions-altitude.csv", header=FALSE, sep=",")
accessions_altitude <- accessions_altitude[,c(-5,-9,-10,-12,-13,-14)]
names(accessions_altitude) <- c("Num", "Platform", "Name","Nation","Lat","Long","Altitude","Group")
accessions_altitude$Altitude = as.numeric(accessions_altitude$Altitude)

library(dplyr)
data_join = inner_join(data,accessions_altitude,by="Num")


##### 相关性分析#####
plot(data_join$Altitude, data_join$sequence.bp,   col = "blue",
     abline(lm(data_join$sequence.bp~data_join$Lat)),cex = 1.3,pch = 16)
accessions_altitude <- accessions_altitude[,c(-9,-12,-13,-14)]


(data$G4_MC_rate_bp~data$sequence.bp)
cor(data_join$Lat, data_join$sequence.bp,method="pearson")
ggplot(data_join[which(data_join$Group=="relict"),],aes(x=sequence.bp,y=G4_MC_rate))+ geom_point(size=1,shape=15)+geom_smooth(method=lm)


#### 不同组的参数对比

boxplot(data_join$G4_MC_rate~data_join$Group)
boxplot(data_join$sequence.bp~data_join$Group)
boxplot(data_join$G4_total_bp~data_join$Group,ylim=c(9e+4,1.1e+5))
boxplot(data_join$Altitude~data_join$Group)







##### relict#####

relict = data_join[which(data_join$Group=="relict"),]
cor(relict$Lat, relict$sequence.bp,method="pearson")
cor(relict$Long, relict$sequence.bp,method="pearson")
cor(relict$Altitude, relict$sequence.bp,method="pearson")
cor(relict$sequence.bp,relict$G4_total,method="pearson")
cor(relict$sequence.bp,relict$G4_MC_rate_bp,method="pearson")
cor(relict$sequence.bp,relict$G4_MC_rate,method="pearson")
ggplot(relict,aes(x=sequence.bp,y=G4_MC_rate_bp))+ geom_point(size=1,shape=15)+geom_smooth(method=lm)
```

### 下载代码更新

```bash
ascp -i ~/.aspera/connect/etc/asperaweb_id_dsa.openssh -l 100M -k 1 -T anonftp@ftp.ncbi.nlm.nih.gov:/geo/samples/GSM2099nnn/GSM2099214/suppl/GSM2099214_allc_6201.tsv.gz ~/data/softwares

```
https://blog.csdn.net/weshengxin/article/details/110118398
## mask 代码

```py
### 一旦有了全部的id 即可
tf_mask = torch.ones(z2tf.shape[0]*z2tf.shape[0])
tf_mask [idx] = 0
# torch.sum(tf_mask) , z2tf.shape[0]*z2tf.shape[0]/2
tf_mask = tf_mask.reshape(z2tf.shape[0],z2tf.shape[0])
```

## 单细胞药学开发

### 应用
        

找到drug target关系利用单细胞转录组可以保存细胞异质性的特点
Bulk在一个组织上直接多个细胞测转录组


### 耐药性研究

对于肿瘤细胞，可能车消除一类细胞后会出现残留细胞主导疾病的现象，因此需要保留细胞异质性信息

对t细胞受体进行单细胞测序可以以好物帮助的活T细胞

### 迁移学习

Bulk转录组测序后做预训练再做做微调


# 2022-3-15

## PLAN

+ **毕业设计图片翻译及成果收集**
+ **单细胞finetune**


## 成果收集

+ /home/ubuntu/project/phage-classifer/layers.py 神经网络架构
+ /home/ubuntu/project/phage-classifer/initial_data.py 数据预处理
+ /home/ubuntu/project/phage-classifer/course_final.py 特征识别


# 2022-3-16

## PLAN
+ **完善下载代码**
+** 修改单细胞训练代码**

## 下载代码步骤

+ 打开tmux
+ `source /etc/bashrc`
+ 下载


# 2022-3-17

## PLAN

+ **修改单细胞mask代码**

## 单细胞代码

### Encoder Pretrain

最新模型 cor 达到0.4-0.7之间

### latent space注意顺序

错误原因:由Adata处发生

# 2022-3-18

## PLAN

+ **单细胞整理后可视化**
+ **TE重构代码**

## TE重构代码

利用paralle 和 相关参数的设定在LTR_FINDER_parallel中修改参数


# 2022-3-19

## PLAN
+ **单细胞工作设计**

## 单细胞工作设计

+ 拿出decoder 的权重 做可视化
+ 跑新的benchmark以及perturbation
  + 研究此前benchmark的R代码
  + 输出特定格式

# 2022-3-21

## PLAN
+ **文献阅读**
+ **权值调控网络可视化**

## 权值

还需解决如何构建网络的问题

**GRN调控网络学习**

### TF predicted-TF 存在线性关系

**Input**: TF-Real

**Output**: linear-relation

## 文献

### 主题

心脏从人类多能干细胞到最终状态分化全程



### 单细胞测序

+ 所有细胞做降维 不同天细胞分离 推测分化路径
+ 单日细胞做无监督学习聚类 表示分化推测

### 转录因子

+ 不同的时间点的不同细胞子群有不同转录调控因子表达量
+ 不同的分支有不同的转录调控网络

# 2022-3-22

## PLAN

+ **研究转录调控机制**
+ **VAE模型预训练pipeline**

## hsc转录调控

![fig 3](https://els-jbs-prod-cdn.jbs.elsevierhealth.com/cms/attachment/e86bafbf-4411-451c-94a5-36d4f7c42a32/gr4.jpg)

## 训练流程

### Code 
```py
## output: the pretrained model
def pretrain(data_z_genes,data_z):
    encoder = encoder_pretrain(data_z_genes,data_z)
    tf2tf_mask,tf2gene_mask = decoder_pretrain(data_z_genes,data_z)
    decoder = decoder_fine_tune(tf2tf_mask,tf2gene_mask,data_z_genes,data_z)
    model = VAE_model.VAE_2(model_encoder=encoder, model_decoder = decoder)
    pretrained_model = finetune(model,data_z_genes,data_z)
    return pretrained_model
```

### Flow

+ 预训练encoder
+ 预训练fully-connected decoder
+ 通过权重进行mask
+ 预训练finetuned decoder
+ 组装成VAE并finetune

# 2022-3-23

## PLAN

+ **单细胞训练pipelien测试**
+ **TE G4 测试**
+ **单细胞benchmark 数据overview**

## 单细胞benchmark 数据overview

两个batch 分别对应两天，可以清晰分开在umap图中

## 单细胞预训练文献

https://academic.oup.com/bioinformatics/article/38/6/1607/6499287#337386334


# 2022-3-24

## PLAN

+ **文献阅读**
+ **R语言脚本overview**
+ **周六journal club ppt**
+ **删除raw 文件**
+ **table 修改**

## R脚本

包括数据读写，通过go去做perturbation 但是需要全部基因数据，明天尝试用sc.write_csv处理

## 文献阅读

通过psudo-label 做pretrain

Steps:

+ 通过基因表达做K-means做label 训练出encoder
+ 通过encoder训练出的representation 对Kmeans中心点做迭代调整，最终训练出较好的encoder
+ fine-tune 训练出通过encoder给出的向量找出好的分类器


消除batch effect

通过多任务计算**总loss** 训练出较好的encoder


# 2022-3-25

## PLAN

+ **PageRank 学习**
+ **R语言图论学习**

## R语言图论学习(igraph)

通过邻接矩阵创建

```r
g <- graph.adjacency(tf_net)
page.rank(g)$vector
```
## PageRank 学习

基于各个节点计算邻接矩阵，通过马尔科夫链求平稳分布估算各个节点的重要程度。

# 2022-3-26

## PLAN

+ **拟南芥可视化函数**
+ **拟南芥结论总结**

## 拟南芥结论

+ TE中G4很容易被甲基化
+ 不同类群中相关性异质化很高
+ TE G4 BP rate没有修正
+ genome大小越依赖于转座子 基因组大小和转座子G4甲基化程度的关联越大

## 拟南芥可视化

+ corrplots 基于不同类群
+ boxplot 比较global 以及 TE-wise

# 2022-3-26

## PLAN
+ **校稿**
+ **气候数据处理**

## 气候数据处理

### R语言处理方法

```r
library(rgdal) 

library(raster)

setwd('/home/ubuntu/data/climate')

lst <- list.files(path=getwd(),pattern='tif$',full.names = T) # 这里用的是tiff格式图层，可根据自己的需要修改，例如# bil、asc 等。数据来源WorldClid网站。

accessions_altitude <-read.table(file="/home/ubuntu/Arabidopsis/accessions-altitude.csv", header=FALSE, sep=",")
accessions_altitude <- accessions_altitude[,c(-5,-9,-10,-12,-13,-14)]
names(accessions_altitude) <- c("Num", "Platform", "Name","Nation","Lat","Long","Altitude","Group")

data = data.frame(Num=accessions_altitude$Num,Lat=accessions_altitude$Lat,Long=accessions_altitude$Long)

attach(data) #据说这个命令最好换成with命令，能力有限不改了。

dim(data)

data<-na.omit(data)

coordinates(data)<-c("Long","Lat") #Lon 为经度，Lat为纬度。

bio_number<-vector()

#运行核心代码，提取每个点的气候信息

result<-matrix(rep(0,1131*19),ncol=19)

for(i in 1:2){
  
  BIO <- raster(lst[[i]]) #读取第i个气候图层
  
  BIO_centroid <- extract(BIO, data, method='simple', buffer=1000, fun=mean, df=TRUE) #提取每个点的气候信息，第i个气候图层，其中用的是均值(座标处不一定有数值)，同时也可选择其他计算方法。
  
  bio_number[i]<-strsplit(strsplit(lst[[i]],split="/")[[1]][5],split=".tif")[[1]] #获取气候图层名(使用"/"分割路径来获取文件名，所以需要指定第几级文件。)
  
  #注意其中的5是指当前图层在第几级文件中。（可对比上下两个路径的例子来理解这一点）
  
  #"E:/Worldclim/30 seconds/version (1.0)/bio1-19_30s_bil/bio_1.bil"   这里设置应为[6]，注意斜杠的方向。
  
  result[,i]<-BIO_centroid[,2]
  
}
```

result 为每一个数据对应的BIO1-19的数值

### Bio 1-19 
BIO1 = Annual Mean Temperature

BIO2 = Mean Diurnal Range (Mean of monthly (max temp - min

temp))

BIO3 = Isothermality(BIO2/BIO7) (* 100)

BIO4 = Temperature Seasonality(standard deviation *100)

BIO5 = Max Temperature of Warmest Month

BIO6 = Min Temperature of Coldest Month

BIO7 = Temperature Annual Range(BIO5-BIO6)

BIO8 = Mean Temperature of Wettest Quarter

BIO9 = Mean Temperature of Driest Quarter

BIO10 = Mean Temperature of Warmest Quarter

BIO11 = Mean Temperature of Coldest Quarter

BIO12 = Annual Precipitation

BIO13 = Precipitation of Wettest Month

BIO14 = Precipitation of Driest Month

BIO15 = Precipitation Seasonality (Coefficient of

Variation)

BIO16 = Precipitation of Wettest Quarter

BIO17 = Precipitation of Driest Quarter

BIO18 = Precipitation of Warmest Quarter

BIO19 = Precipitation of Coldest Quarter


# 2022-3-28

## PLAN

+ **气候数据整理**
+ **图深度学习**
+ **初步观察结果**


## 数据处理分组

### 分组1

基因组大小，TE数量，TE上有G4的数量，TE上有G4的比例

### 分组2

基因组大小，TEbp，TE上有G4的bp，TE上有G4的比例bp

### 分组3

基因组大小，TE数量，G4在全基因组的数量，G4在TE的数量比例

### 分组4

基因组大小，TE数量，G4在全基因组甲基化的数量，G4在TE的甲基化数量比例


## 图神经网络


### node2vec

分为两步，第一步为基于深度优先或广度优先的随机游走。第二步为skipgram计算每一下节点的嵌入向量


### GCN

只通过每一个结点的特征和邻接矩阵进行训练，通过多层神经网络，找到每个节点的embedding
损失函数通过特定问题定义

# 2022-3-29

## PLAN

+ **解决index问题**
+ **单细胞可视化 Ding Script**
+ **拟南芥可视化**

## index 问题解决

利用fastaNormalizaion来解决

软件位置 /home/ubuntu/data/softwares/picard.jar

软件使用网站 https://broadinstitute.github.io/picard/command-line-overview.html

FastaNormalization

```bash
java -jar picard.jar NormalizeFasta \
      I=input_sequence.fasta \
      O=normalized_sequence.fasta
```

在服务器中使用

+ 修复软件
+ 重命名

```bash
## FastaNormalization
java -jar /home/ubuntu/data/softwares/picard.jar NormalizeFasta \
      -I /home/ubuntu/Arabidopsis/Arabidopsis_sequence/159/chr5.fasta \
      -O /home/ubuntu/Arabidopsis/Arabidopsis_sequence/159/chr5n.fasta

## Overwrite
mv /home/ubuntu/Arabidopsis/Arabidopsis_sequence/159/chr5n.fasta /home/ubuntu/Arabidopsis/Arabidopsis_sequence/159/chr5.fasta
```

## 拟南芥可视化

### boxplot

+ 25% LTR中有TE
+ relict G4含量少
+ 明显TE中G4甲基化程度小

### corrplots

+ 急需多类别转座子分类
+ 目前能推出TE 和基因组关系 去掉没有G4的TE再看

# 2022-3-30

## PLAN

+ **单细胞umap降维**
+ **tf调控网络**
+ **文献阅读**

## GRN

+ 从神经网络下载邻接矩阵
+ 构建图g
+ 通过图g 创建邻接表
+ rbind 连接两个表

```r
ael <- as_adj_edge_list(g)
```

## 单细胞训练

需要调高epoch

## 文献阅读

通过遗传信息介导 由于基因和表型的但方向性 只能基因影响表型 不能表型影响基因进行推断

2-sample 很重要！！


# 2022-3-31

## PLAN

+** 整理拟南芥数据**
+ 单细胞网络
+ MR方法

## 拟南芥数据


+ TE_G4(bp):即与位于TE中G4结构的数量（bp数）,从TE_G4.csv中获取
+ TE_G4_mc（bp）：位于TE中G4结构的甲基化数量（bp数）
+ TE_G4_mc_rate:位于TE中G4结构的甲基化程度
            TE_G4_mc_rate=float(TE_G4_mc)/float(TE_G4)
+ TE_G4_mc_bp_rate：先计算a=float(TE_G4_mc_bp)/float(TE_G4_bp)
        再求b=float(TE_mc_bp)/float(TE_bp)
        TE_G4_mc_bp_rate=a/b
+ TE_mc_bp：该染色体中TE被甲基化的bp数           
+ TE(bp):即TE的总数量（bp数），总数量：读取tmp1，每一行对应一个TE+1，bp则在-hist可直接读
+ G4（bp):即G4的总数量（bp数）,从“number.csv”中读取
+ TE_G4(bp):即与位于TE中G4结构的数量，倒数第四列即指明了该TE中与几个G4结构重叠，累加即可
+ TE_G4_rate（bp）：G4中位于TE的比例
            TE_G4_rate=float(TE_G4)/float(G4)
+ G4_TE(bp):包含G4结构的TE数目（bp数）
+ G4_TE_rate（bp）：TE中包含G4结构的比例
            G4_TE_rate=float(G4_TE)/float(TE)

### 有问题数据

+ /home/ubuntu/Arabidopsis/Scripts/datasetTE1.csv 中 G4_TE_bp_rate,G4_TE_rate,T4_G4_bp_rate,T4_G4_rate 
+ G4_TE_bp_rate

### TE 转座子benchmark

https://genomebiology.biomedcentral.com/articles/10.1186/gb-2004-5-10-r79#MOESM4

### 问题
d
TE数量变化实际并不大

## GRN

需要重新学习graph_from_data_frame